<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update Profile Picture</title>
    <link rel="stylesheet" href="/styles/stylesheet.css">
</head>
<body>

    <nav th:replace="fragments/navbar :: navbar"></nav>

    <div class="content">

        <form th:action="@{/addProfilePicture}" method="post" enctype="multipart/form-data">
            <!--HIDDEN-->
            <input type="hidden" th:name="username"  th:value="${user.username}" id="username"/>
            <input type="hidden" th:name="fileContent" th:value="null" id="fileContent"/>
            <input type="hidden" th:name="fileType" th:value="null" id="fileType"/>

            <h1>Update Profile Picture</h1><br>

            <div class="container">
                <table>
                    <row>
                        <!-- if user.image != null, show user image, else show generic user icon- th:src="${user.profileImagePath}==null ? '/GenericUserIcon.jpg' : ${user.profileImagePath}"-->
                        <img th:src="${user.profileImagePath}" style="z-index: 1;" id="profile-image-display" alt="profilePhoto">

                        <!-- if user.image = null hide, else show th:style="${user.profileImagePath}==null ? 'display:none;' : 'z-index: 2;'-->
                        <form th:action="@{/removeProfilePicture}" method="delete" ><img src="/deleteIcon.png" class="icon" width="25px" alt="deleteIcon"></form>

                        <div id="root"></div>
                    </row>
                </table>

            </div>

            <h4>Upload a new photo</h4>
            <input type="file" id="img-input" class="button" th:name="image" accept=".jpg,.png,.jpeg">
            <br><label class="helper" >Must be filetype jpg, jpeg, or png, and will be cropped to 1:1 ratio</label><br>
            <p class="helper">Upload an image to see the preview</p><br><br>
            <p class="error" th:text="${deleteMessage}"></p>
            <p class="error" th:name="errorMessage" th:text="@{errorMessage}"></p>
            <input class="button" type="submit" value="Save new Profile Picture" />
        </form><br>
    </div>

</body>
</html>

<script>
    let profileImageInput = document.getElementById("img-input");

    const MAX_PIXELS = 150;
    let excessWidth= 0;
    let excessHeight=0;
    let maxSize=0;

    function calculateSize(width, height) {
        if (width === height) {
            return 0, 0, width;
        } else {
            if (width > height) {
                maxSize = height;
            } else {
                maxSize = width;
            }
        }
        excessWidth = width - maxSize;
        excessHeight = height - maxSize;
    }

    profileImageInput.onchange = function() {
        if (document.getElementById("root").childElementCount !== 0) {
            //delete canvas before new one is created
            let children = document.getElementById("root").childNodes;
            let oldCanvas = document.getElementById("root").removeChild(children[0]);
        }
        const [file] = profileImageInput.files
        if (file) {
            const blobURL = URL.createObjectURL(file);
            const img = new Image();
            img.src = blobURL;
            img.onerror = function() {
                URL.revokeObjectURL(this.src);
                console.log("Cannot load image");
            }
            img.onload = function () {
                URL.revokeObjectURL(this.src);
                const canvas = document.createElement("canvas");
                canvas.width = MAX_PIXELS;
                canvas.height = MAX_PIXELS;
                calculateSize(img.width, img.height);
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, excessWidth/2, excessHeight/2, maxSize, maxSize, 0, 0, MAX_PIXELS, MAX_PIXELS);
                document.getElementById("root").appendChild(canvas);

                let imageData = ctx.getImageData(0, 0, MAX_PIXELS, MAX_PIXELS);
                let byteArray = imageData.data;
                //set file type
                document.getElementById("fileType").value="png";
                //set byteArray
                document.getElementById("fileContent").value=byteArray;
            }
        }
    };
</script>


<style>

    label.helper, p.helper{
        margin-left: 5px;
        margin-top: 5px;
        font-style: italic;
        font-weight: normal;
        color: dimgrey;
    }

    .button {
        font-size: medium;
        text-decoration: none;
        background-color: #EEEEEE;
        color: #333333;
        padding: 4px 10px 4px 10px;
        border-bottom: 1px solid lightgray;
        border-radius: 3px;
    }

    div.content {
        margin-left: 200px;
    }

    h1 {
        text-align: center;
        font-weight: normal;
    }

    h4 {
        margin-bottom: 5px;
    }

    .content {
        border: #F67B50 solid 2px;
        border-radius: 10px;
        padding: 20px;
        margin: 5px;
        width: auto;
    }

    .icon {
        margin-left: -20px;
        margin-bottom: -12px;
    }

    #profile-image-display {
        width:150px;
        height:150px;
        object-fit:cover;
    }

    #root {
        display: inline-block;
    }

    .error {
        margin-left: 10px;
        color: red;
        margin-top: 20px;
        margin-bottom: -20px;
    }
</style>